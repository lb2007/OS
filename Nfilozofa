#include <stdio.h>
#include <stdlib.h>
#include <pthread.h>
#include <sys/types.h>
#include <unistd.h>
#include <sys/ipc.h>
#include <sys/sem.h>
#include <sys/shm.h>
#include <sys/wait.h>

int broj_ruku[100];
pthread_mutex_t monitor;
pthread_cond_t red;
int broj_stapica;
int n, m;


void uzmi_stapice(int i){

	pthread_mutex_lock(&monitor);
	while (broj_ruku[i]> broj_stapica)
	pthread_cond_wait(&red, &monitor);
	broj_stapica-=broj_ruku[i];
	printf("Nakon uzimanja %d stapica, na stolu je %d\n", broj_ruku[i], broj_stapica);
	sleep(2);
	pthread_mutex_unlock(&monitor);
}

void vrati_stapice(int i){
	pthread_mutex_lock(&monitor);
	broj_stapica+=broj_ruku[i];
	printf("Nakon vracanja %d stapica, na stolu je %d\n", broj_ruku[i], broj_stapica);
	sleep(2);
	pthread_mutex_unlock(&monitor);
}

void *filozof(int i){
	m=n;
	printf("Na stolu je %d stapica, filozof uzima %d stapica\n", broj_stapica, broj_ruku[i]);	
	while(m>0){
	uzmi_stapice(i);
	printf("Filozof %d jede\n",i );
	sleep(2);
	vrati_stapice(i);
	printf("Filozof %d  misli\n",i );
	sleep(2);
	m--;
	}
}


int main(int argc, char *argv[]){


	FILE *file;

	int broj_filozofa;
	pthread_t *filozofi=NULL;
	n=atoi(argv[1]);
	
	printf("Pocetak\n");
	printf("Broj ponavljanja iznosi %d\n", n);
	
	file=fopen("filozofi.txt", "r");
	fscanf(file,"%d",&broj_stapica);
	printf("Broj stapica iznosi: %d\n", broj_stapica);
	fscanf(file, "%d", &broj_filozofa);
	printf("Broj filozofa iznosi: %d\n", broj_filozofa);

	filozofi=(pthread_t*) malloc (broj_filozofa*sizeof(pthread_t));
		
	if(!filozofi) {
		printf("ERROR\n");
		exit(0);
		}

	for(int i=0; i<broj_filozofa; i++){
		fscanf(file, "%d", &broj_ruku[i]);
		printf("Filozof %d misli\n", i);
		pthread_create(filozofi+i, NULL, filozof, i);
		sleep(2);
	}

	for(int i=0; i<broj_filozofa; i++){
		pthread_join(filozofi[i], NULL);
	}

	fclose(file);

	pthread_mutex_destroy(&monitor);

	return 0;

}
